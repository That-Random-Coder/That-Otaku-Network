<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Anime-Verse ‚Äî User Profiles</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        max-width: 900px;
        margin: 24px auto;
      }
      h1 {
        margin-top: 28px;
      }
      form {
        margin-bottom: 20px;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f8f8f8;
      }
      input,
      textarea,
      button,
      select {
        padding: 8px;
        font-size: 14px;
        margin-top: 6px;
        width: 100%;
        box-sizing: border-box;
      }
      .row {
        display: flex;
        gap: 12px;
      }
      .row > * {
        flex: 1;
      }
      .small {
        width: auto;
        display: inline-block;
      }
      .profile-img {
        max-width: 220px;
        border-radius: 8px;
        display: block;
        margin-top: 10px;
      }
      .muted {
        color: #666;
        font-size: 13px;
      }
      .result {
        margin-top: 12px;
      }
      .inline {
        display: inline-block;
        width: auto;
      }
    </style>
  </head>
  <body>
    <h1>Anime-Verse ‚Äî User Profiles</h1>

    <p class="muted">
      Set your API base URL if your user service is hosted elsewhere (default is
      <code>http://localhost:11111/user</code> to match the controller
      mappings).
    </p>

    <label for="apiBase">API Base URL</label>
    <input id="apiBase" value="http://localhost:11111/api/profile/user" />

    <label for="token">JWT Token (include the "Bearer " prefix)</label>
    <input id="token" placeholder="Bearer eyJ..." />

    <hr />

    <h2>Create User Profile ‚úÖ</h2>
    <form id="createForm">
      <label>User ID (UUID)</label>
      <input id="createId" required />

      <label>Username</label>
      <input id="createUsername" required />

      <label>Display Name</label>
      <input id="createDisplayName" />

      <label>Bio</label>
      <textarea id="createBio"></textarea>

      <label>Location</label>
      <input id="createLocation" />

      <label>Date of Birth</label>
      <input id="createDob" type="date" />

      <label>Profile Image (required by API)</label>
      <input id="createImage" type="file" accept="image/*" required />

      <button type="submit">Create</button>
    </form>

    <h2>Get User Profile üîé</h2>
    <div class="row">
      <input id="getId" placeholder="User ID (UUID)" />
      <button id="btnGet" class="small">Get</button>
    </div>

    <h2>Update Profile Image üñºÔ∏è</h2>
    <div class="row">
      <input id="imgId" placeholder="User ID (UUID)" />
      <input id="imgFile" type="file" accept="image/*" />
      <button id="btnUploadImage" class="small">Upload Image</button>
    </div>

    <h2>Update Profile ‚úçÔ∏è</h2>
    <form id="updateForm">
      <label>User ID</label>
      <input id="updateId" required />

      <label>Display Name</label>
      <input id="updateDisplayName" />

      <label>Bio</label>
      <textarea id="updateBio"></textarea>

      <label>Location</label>
      <input id="updateLocation" />

      <label>Date of Birth</label>
      <input id="updateDob" type="date" />

      <button type="submit">Update Profile</button>
    </form>

    <h2>Follow / Unfollow üë•</h2>
    <div class="row">
      <input id="followUserId" placeholder="Your User ID (UUID)" />
      <input id="followTargetId" placeholder="Target User ID (UUID)" />
      <div style="display: flex; gap: 8px">
        <button id="btnFollow" class="small">Follow</button>
        <button id="btnUnfollow" class="small">Unfollow</button>
      </div>
    </div>

    <hr />

    <h2>Result</h2>
    <div id="userResult" class="result"></div>

    <script>
      const getApiBase = () =>
        document.getElementById("apiBase").value.replace(/\/$/, "");
      const getToken = () => {
        const t = document.getElementById("token").value.trim();
        if (!t) return {};
        // Auto-prepend "Bearer " if missing
        const token = t.startsWith("Bearer ") ? t : `Bearer ${t}`;
        return { Authorization: token };
      };

      function showMessage(msg) {
        alert(msg);
      }

      function displayUser(data) {
        const out = document.getElementById("userResult");
        if (!data) {
          out.innerHTML = '<div class="muted">No user data</div>';
          return;
        }

        let html = `<div class="user-info"><strong>ID:</strong> ${data.id}<br>
        <strong>Username:</strong> ${data.username}<br>
        <strong>Display Name:</strong> ${data.displayName || "-"}<br>
        <strong>Bio:</strong> ${data.bio || "-"}<br>
        <strong>Location:</strong> ${data.location || "-"}<br>
        <strong>Date of Birth:</strong> ${data.dateOfBirth || "-"}<br>
        <strong>Followers:</strong> ${data.followers ?? 0}<br>
        <strong>Following:</strong> ${data.following ?? 0}<br>
        `;

        if (data.profileImg && data.imageType) {
          html += `<img src="data:${data.imageType};base64,${data.profileImg}" alt="Profile Image" class="profile-img">`;
        }

        html += "</div>";
        out.innerHTML = html;
      }

      // Create user
      document
        .getElementById("createForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const base = getApiBase();
          const headers = getToken();

          const id = document.getElementById("createId").value.trim();
          const username = document
            .getElementById("createUsername")
            .value.trim();
          const displayName = document
            .getElementById("createDisplayName")
            .value.trim();
          const bio = document.getElementById("createBio").value.trim();
          const location = document
            .getElementById("createLocation")
            .value.trim();
          const dateOfBirth =
            document.getElementById("createDob").value || null;

          const dto = { id, username, displayName, bio, location, dateOfBirth };

          const formData = new FormData();
          formData.append(
            "requestDto",
            new Blob([JSON.stringify(dto)], { type: "application/json" })
          );
          const file = document.getElementById("createImage").files[0];
          if (!file) {
            showMessage("Profile image is required by the API");
            return;
          }
          formData.append("file", file);

          try {
            const res = await fetch(`${base}/profile/create`, {
              method: "POST",
              headers: headers,
              body: formData,
            });
            if (!res.ok) {
              const err = await res
                .json()
                .catch(() => ({ message: "unknown" }));
              showMessage("Error: " + JSON.stringify(err));
              return;
            }
            const data = await res.json();
            showMessage("User created.");
            displayUser(data);
          } catch (err) {
            console.error(err);
            showMessage("Failed to create user");
          }
        });

      // Get user
      document.getElementById("btnGet").addEventListener("click", async () => {
        const id = document.getElementById("getId").value.trim();
        if (!id) {
          showMessage("Please provide an ID");
          return;
        }
        const base = getApiBase();
        const headers = getToken();
        try {
          const res = await fetch(
            `${base}/profile/get?id=${encodeURIComponent(id)}`,
            { headers }
          );
          if (!res.ok) {
            const err = await res.json().catch(() => ({ message: "unknown" }));
            showMessage("Error: " + JSON.stringify(err));
            return;
          }
          const data = await res.json();
          displayUser(data);
        } catch (err) {
          console.error(err);
          showMessage("Failed to fetch user");
        }
      });

      // Upload image
      document
        .getElementById("btnUploadImage")
        .addEventListener("click", async () => {
          const id = document.getElementById("imgId").value.trim();
          const file = document.getElementById("imgFile").files[0];
          if (!id || !file) {
            showMessage("Provide user id and image file");
            return;
          }
          const base = getApiBase();
          const headers = getToken();

          const formData = new FormData();
          formData.append("file", file);

          try {
            const res = await fetch(
              `${base}/profile/image/update?id=${encodeURIComponent(id)}`,
              {
                method: "PUT",
                headers: headers,
                body: formData,
              }
            );
            if (!res.ok) {
              const err = await res
                .json()
                .catch(() => ({ message: "unknown" }));
              showMessage("Error: " + JSON.stringify(err));
              return;
            }
            const ok = await res.json();
            showMessage("Image updated");
          } catch (err) {
            console.error(err);
            showMessage("Failed to upload image");
          }
        });

      // Update profile (PUT)
      document
        .getElementById("updateForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = document.getElementById("updateId").value.trim();
          if (!id) {
            showMessage("Provide user id");
            return;
          }
          const dto = {
            displayName:
              document.getElementById("updateDisplayName").value.trim() || null,
            bio: document.getElementById("updateBio").value.trim() || null,
            location:
              document.getElementById("updateLocation").value.trim() || null,
            dateOfBirth: document.getElementById("updateDob").value || null,
          };

          const base = getApiBase();
          const headers = Object.assign(
            { "Content-Type": "application/json" },
            getToken()
          );

          try {
            const res = await fetch(
              `${base}/profile/update?id=${encodeURIComponent(id)}`,
              {
                method: "PUT",
                headers: headers,
                body: JSON.stringify(dto),
              }
            );
            if (!res.ok) {
              const err = await res
                .json()
                .catch(() => ({ message: "unknown" }));
              showMessage("Error: " + JSON.stringify(err));
              return;
            }
            const data = await res.json();
            showMessage("Profile updated");
            displayUser(data);
          } catch (err) {
            console.error(err);
            showMessage("Failed to update profile");
          }
        });

      // Follow / Unfollow
      document
        .getElementById("btnFollow")
        .addEventListener("click", async () => {
          const userId = document.getElementById("followUserId").value.trim();
          const targetId = document
            .getElementById("followTargetId")
            .value.trim();
          if (!userId || !targetId) {
            showMessage("Provide both user id and target id");
            return;
          }
          const base = getApiBase();
          const headers = getToken();
          try {
            const res = await fetch(
              `${base}/${encodeURIComponent(
                userId
              )}/follow/${encodeURIComponent(targetId)}`,
              { method: "POST", headers }
            );
            if (!res.ok) {
              const err = await res
                .json()
                .catch(() => ({ message: "unknown" }));
              showMessage("Error: " + JSON.stringify(err));
              return;
            }
            showMessage("Followed successfully");
          } catch (err) {
            console.error(err);
            showMessage("Failed to follow");
          }
        });

      document
        .getElementById("btnUnfollow")
        .addEventListener("click", async () => {
          const userId = document.getElementById("followUserId").value.trim();
          const targetId = document
            .getElementById("followTargetId")
            .value.trim();
          if (!userId || !targetId) {
            showMessage("Provide both user id and target id");
            return;
          }
          const base = getApiBase();
          const headers = getToken();
          try {
            const res = await fetch(
              `${base}/${encodeURIComponent(
                userId
              )}/follow/${encodeURIComponent(targetId)}`,
              { method: "DELETE", headers }
            );
            if (!res.ok) {
              const err = await res
                .json()
                .catch(() => ({ message: "unknown" }));
              showMessage("Error: " + JSON.stringify(err));
              return;
            }
            showMessage("Unfollowed successfully");
          } catch (err) {
            console.error(err);
            showMessage("Failed to unfollow");
          }
        });
    </script>
  </body>
</html>
